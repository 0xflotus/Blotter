Object.keys||(Object.keys=function(){"use strict";var t=Object.prototype.hasOwnProperty,e=!{toString:null}.propertyIsEnumerable("toString"),i=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],r=i.length;return function(o){if("object"!=typeof o&&("function"!=typeof o||null===o))throw new TypeError("Object.keys called on non-object");var n,a,s=[];for(n in o)t.call(o,n)&&s.push(n);if(e)for(a=0;r>a;a++)t.call(o,i[a])&&s.push(i[a]);return s}}()),GrowingPacker=function(){},GrowingPacker.prototype={fit:function(t){var e,i,r,o=t.length,n=o>0?t[0].w:0,a=o>0?t[0].h:0;for(this.root={x:0,y:0,w:n,h:a},e=0;o>e;e++)r=t[e],(i=this.findNode(this.root,r.w,r.h))?r.fit=this.splitNode(i,r.w,r.h):r.fit=this.growNode(r.w,r.h)},findNode:function(t,e,i){return t.used?this.findNode(t.right,e,i)||this.findNode(t.down,e,i):e<=t.w&&i<=t.h?t:null},splitNode:function(t,e,i){return t.used=!0,t.down={x:t.x,y:t.y+i,w:t.w,h:t.h-i},t.right={x:t.x+e,y:t.y,w:t.w-e,h:i},t},growNode:function(t,e){var i=t<=this.root.w,r=e<=this.root.h,o=r&&this.root.h>=this.root.w+t,n=i&&this.root.w>=this.root.h+e;return o?this.growRight(t,e):n?this.growDown(t,e):r?this.growRight(t,e):i?this.growDown(t,e):null},growRight:function(t,e){this.root={used:!0,x:0,y:0,w:this.root.w+t,h:this.root.h,down:this.root,right:{x:this.root.w,y:0,w:t,h:this.root.h}};var i=this.findNode(this.root,t,e);return i?this.splitNode(i,t,e):null},growDown:function(t,e){this.root={used:!0,x:0,y:0,w:this.root.w,h:this.root.h+e,down:{x:0,y:this.root.h,w:this.root.w,h:e},right:this.root};var i=this.findNode(this.root,t,e);return i?this.splitNode(i,t,e):null}};var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var t=document.createElement("canvas");return!(!window.WebGLRenderingContext||!t.getContext("webgl")&&!t.getContext("experimental-webgl"))}catch(e){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var t=document.createElement("div");return t.id="webgl-error-message",t.style.fontFamily="monospace",t.style.fontSize="13px",t.style.fontWeight="normal",t.style.textAlign="center",t.style.background="#fff",t.style.color="#000",t.style.padding="1.5em",t.style.width="400px",t.style.margin="5em auto 0",this.webgl||(t.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),t},addGetWebGLMessage:function(t){var e,i,r;t=t||{},e=void 0!==t.parent?t.parent:document.body,i=void 0!==t.id?t.id:"oldie",r=Detector.getWebGLErrorMessage(),r.id=i,e.appendChild(r)}};"object"==typeof module&&(module.exports=Detector),!function(){var t={version:"1.0.0"},e=["ms","moz","webkit","o"],i=function(){for(var t=0,i=window.requestAnimationFrame,r=window.cancelAnimationFrame,o=e,n=0;n<o.length&&!i;++n)i=window[o[n]+"RequestAnimationFrame"],r=window[o[n]+"CancelAnimationFrame"]||window[o[n]+"CancelRequestAnimationFrame"];return i||(i=function(e,i){var r=(new Date).getTime(),o=Math.max(0,16-(r-t)),n=window.setTimeout(function(){e(r+o)},o);return t=r+o,n}),r||(r=function(t){clearTimeout(t)}),{requestAnimationFrame:function(t){i.call(window,t)},cancelAnimationFrame:function(t){r.call(window,t)}}}(),r=function(){function t(t,e){return t+": "+e}return{logError:function(e,i){var r=t(e,i);console.error(r)},throwError:function(e,i){var r=t(e,i);throw r}}}(),o={hiDpiCanvas:function(t,e,i){i=i||this.pixelRatio();var r=document.createElement("canvas");return r.width=t*i,r.height=e*i,r.style.width=t+"px",r.style.height=e+"px",r.getContext("2d").setTransform(i,0,0,i,0,0),r},pixelRatio:function(){for(var t=2,i=document.createElement("canvas").getContext("2d"),r=window.devicePixelRatio||1,o=i.backingStorePixelRatio,n=0;n<e.length&&!o;++n)o=i[e[n]+"BackingStorePixelRatio"];return o=o||1,r/o*t}},n={family:"sans-serif",size:12,leading:1.5,fill:"#000",style:"normal",weight:500,padding:0,paddingTop:null,paddingRight:null,paddingBottom:null,paddingLeft:null},a={Properties:function(){return Object.keys(n)}(),ensurePropertyValues:function(t){for(var e=t||{},i=n,r=0;r<this.Properties.length;r++){var o=this.Properties[r];o in e&&(i[o]=e[o])}return i},stringifiedPadding:function(t){var e=t||this.ensurePropertyValues(),i=t.paddingTop||e.padding,r=e.paddingRight||e.padding,o=e.paddingBottom||e.padding,n=e.paddingLeft||e.padding;return""+i+"px "+r+"px "+o+"px "+n+"px"},sizeForText:function(t,e){var i,r=document.createElement("p"),e=this.ensurePropertyValues(e);return r.innerHTML=t,r.style.fontFamily=e.family,r.style.fontSize=e.size+"px",r.style.fontWeight=e.weight,r.style.fontStyle=e.style,r.style.padding=this.stringifiedPadding(e),r.style.lineHeight=e.leading,r.style.visibility="hidden",r.style.display="inline-block",document.body.appendChild(r),i={w:r.offsetWidth,h:r.offsetHeight},document.body.removeChild(r),i}};t.Text=function(t,e){this.init(t,e)},t.Text.prototype=function(){function e(){var t=(new Date).getTime();window.performance&&"function"==typeof window.performance.now&&(t+=performance.now());var e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?i:3&i|8).toString(16)});return e}return{constructor:t.Text,init:function(t,i){this.id=e.call(this),this.value=t,this.properties=a.ensurePropertyValues(i)}}}(),t.Mapper=function(t){this.init.apply(this,arguments)},t.Mapper.prototype=function(){function e(e,o){e instanceof Array||(e=[e]);for(var n=0;n<e.length;n++){var a=e[n];e instanceof t.Text&&r.throwError("Blotter.Mapper","argument must be instance of Blotter.Text or array of objects that are instances of Blotter.Text"),o.call(this,a)}i.call(this)}function i(){var t=new GrowingPacker,e=[];for(var i in this.textsSizes){var r=this.textsSizes[i];r.referenceId=i,e.push(r)}t.fit(e.sort(n));for(var o=0;o<e.length;o++){var a=e[o];this.textsSizes[a.referenceId].fit=a.fit}this.width=t.root.w,this.height=t.root.h}function n(t,e){var i=t.w*t.h,r=e.w*e.h;return r-i}return{constructor:t.Mapper,init:function(t){this.texts=[],this.textsSizes={},this.width=0,this.height=0,this.addTexts(t)},addTexts:function(t){e.call(this,t,function(t){var e=this.textsSizes[t.id];if(-1==this.texts.indexOf(t)&&this.texts.push(t),!e){var i=a.sizeForText(t.value,t.properties);this.textsSizes[t.id]=i}})},removeTexts:function(t){e.call(this,t,function(t){var e=this.texts.indexOf(t);-1!=e&&this.texts.splice(e,1),delete this.textsSizes[t.id]})},sizeForText:function(t){return this.textsSizes[t.id]},toCanvas:function(){for(var t=o.hiDpiCanvas(this.width,this.height),e=t.getContext("2d"),i=0;i<this.texts.length;i++){var r=this.texts[i],n=this.textsSizes[r.id],a=(n.h*r.properties.leading-n.h)/2;e.font=r.properties.style+" "+r.properties.weight+" "+r.properties.size+"px "+r.properties.family,e.fillStyle=r.properties.fill,e.fillText(r.value,n.fit.x+r.properties.paddingLeft,n.fit.y+r.properties.paddingTop+a)}return t},getImage:function(){return this.toCanvas().toDataURL()}}}();var s={UniformTypes:["1f","2f","3f","4f"],validValueForUniformType:function(t,e){var i=!1,r=function(t,e,i){return!isNaN(t)};switch(t){case"1f":i=!isNaN(e)&&[e].every(r);break;case"2f":i=Array.isArray(e)&&2==e.length&&e.every(r);break;case"3f":i=Array.isArray(e)&&3==e.length&&e.every(r);break;case"4f":i=Array.isArray(e)&&4==e.length&&e.every(r)}return i}};t.MaterialRenderer=function(t){this.init(t)},t.MaterialRenderer.prototype=function(){return{constructor:t.MaterialRenderer,init:function(t){var e=t.width,i=t.height;Detector.webgl||r.throwError("Blotter.MaterialRenderer","device does not support webgl"),t.threeMaterial||r.throwError("Blotter.MaterialRenderer","material does not expose property threeMaterial. Did you forget to call #load on material before instantiating Blotter.MaterialRenderer?"),this.pixelRatio=o.pixelRatio(),this.ratioAdjustedWidth=e*this.pixelRatio,this.ratioAdjustedHeight=i*this.pixelRatio,this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setSize(this.ratioAdjustedWidth,this.ratioAdjustedHeight),this.domElement=this.renderer.domElement,$(this.domElement).css({width:e,height:i}),$(this.domElement).attr({width:this.ratioAdjustedWidth,height:this.ratioAdjustedHeight}),this.scene=new THREE.Scene,this.camera=new THREE.Camera,this.geometry=new THREE.PlaneGeometry(2,2,0),this.material=t,this.mesh=new THREE.Mesh(this.geometry,this.material.threeMaterial),this.scene.add(this.mesh)},start:function(){this.currentAnimationLoop||this.loop()},loop:function(){var t=this;this.renderer.render(this.scene,this.camera),this.currentAnimationLoop=i.requestAnimationFrame(function(){t.loop()})},stop:function(){this.currentAnimationLoop&&(i.cancelAnimationFrame(this.currentAnimationLoop),this.currentAnimationLoop=void 0)},teardown:function(){this.stop(),this.renderer=null,this.canvas.remove()}}}();var h=function(t,e,i){this.init(t,e,i)};h.prototype=function(){return{constructor:h,init:function(t,e,i){Detector.webgl||r.throwError("blotter_Renderer","device does not support webgl"),this.material=i,this.pixelRatio=o.pixelRatio(),this.ratioAdjustedWidth=t*this.pixelRatio,this.ratioAdjustedHeight=e*this.pixelRatio,this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setSize(this.ratioAdjustedWidth,this.ratioAdjustedHeight),this.domElement=this.renderer.domElement,$(this.domElement).css({width:t,height:e}),$(this.domElement).attr({width:this.ratioAdjustedWidth,height:this.ratioAdjustedHeight}),this.scene=new THREE.Scene,this.camera=new THREE.Camera,this.geometry=new THREE.PlaneGeometry(2,2,0),this.mesh=new THREE.Mesh(this.geometry,this.material),this.scene.add(this.mesh)},start:function(){this.currentAnimationLoop||this.loop()},loop:function(){var t=this;this.renderer.render(this.scene,this.camera),this.currentAnimationLoop=i.requestAnimationFrame(function(){t.loop()})},stop:function(){this.currentAnimationLoop&&(i.cancelAnimationFrame(this.currentAnimationLoop),this.currentAnimationLoop=void 0)},teardown:function(){this.stop(),this.renderer=null,this.canvas.remove()}}}();var l=["precision highp float;","uniform sampler2D uSampler;","uniform sampler2D spriteIndices;","uniform sampler2D textSpriteBoundsTexture;","uniform sampler2D centerPointTexture;","uniform float uTime;","uniform float canvasWidth;","uniform float canvasHeight;","uniform float lenseWeight;","varying vec2 vTexCoord;","void main(void) {","   vec2 aspect = vec2(canvasWidth, canvasHeight).xy;","   vec4 spriteIndexData = texture2D(spriteIndices, vTexCoord);","   float spriteIndex = spriteIndexData.x;","   vec4 spriteData = texture2D(textSpriteBoundsTexture, vec2(spriteIndex, 0.5));","   // p = x, y percentage for texel position within of total resolution","   vec2 p = (gl_FragCoord.xy - spriteData.rg) / spriteData.ba;","   // m = x, y percentage for center position within total resolution","   // note: you should know this, but swizzling allows access to vecN data using x,y,z, and w (or r, g, b, and a) in that order.","   vec4 centerPointData = texture2D(centerPointTexture, vec2(spriteIndex, 0.5));","   vec2 m = centerPointData.xy;","   //vec2 m = vec2(0.5);","   // d = difference between p and m (obviously, but see above).","   vec2 d = p - m;","   // The dot function returns the dot product of the two","   // input parameters, i.e. the sum of the component-wise","   // products. If x and y are the same the square root of","   // the dot product is equivalent to the length of the vector.","   // Therefore, r = length of vector represented by d (the ","   // distance of the texel from center position).","   // In order to apply weights here, we add our weight to this distance","   // (pushing it closer to 1 - essentially giving no effect at all) and","   // find the min between our weighted distance and 1.0","   float inverseLenseWeight = 1.0 - lenseWeight;","   float r = min(sqrt(dot(d, d)) + inverseLenseWeight, 1.0);","   vec2 offsetUV = m + (d * r);","   vec2 adjustedFragCoord = spriteData.rg + vec2((spriteData.b * offsetUV.x), (spriteData.a * offsetUV.y));","   //adjustedFragCoord.x = clamp(adjustedFragCoord.x, spriteData.r, (spriteData.r + spriteData.b));","   //adjustedFragCoord.y = clamp(adjustedFragCoord.y, spriteData.g, (spriteData.g + spriteData.a));","   vec2 uv = adjustedFragCoord.xy / aspect;","   // RGB shift","   vec2 offset = vec2(0.0);","   if (r < 1.0) {","     float amount = 0.0013;","     float angle = 0.45;","     offset = (amount * (1.0 - r)) * vec2(cos(angle), sin(angle));","   }","   vec4 cr = texture2D(uSampler, (uv + offset));","   vec4 cga = texture2D(uSampler, uv);","   vec4 cb = texture2D(uSampler, (uv - offset));","   vec4 outColor = vec4(0.0);","   if (cr.r > 0.0 || cga.g > 0.0 || cb.b > 0.0) {","   //if (r < 1.0) {","     // Adjust rgb values so that colors with transparency appear as if they were atop an opaque white background.","     // (vec4(0.0, 0.0, 0.0, 0.5) _atop white_ is visibly the same as vec4(0.5, 0.5, 0.5, 0.0))","     if (cr.a != 0.0) {","       cr.r = cr.r + cr.a;","     }","     if (cga.a != 0.0) {","       cga.g = cga.g + cga.a;","     }","     if (cb.b != 0.0) {","       cb.b = cb.b + cb.a;","     }","     // Ensure offseted/shifted texels have alpha similar to the texel they are offsetting","     // (this prevents texel from being invisible if cga.a = vec4(0.0, 0.0, 0.0, 0.0)","     cga.a = max(cga.a, max(cr.a, cb.a));","     // Set alpha adjustment value so that white texels keep their transparency.","   	float alpha = 1.0 - cga.a;","     // Invert colors (this is cheating but optimal) so that we have CMYK rather than RGB","     // shifted colors and the combination of offsets creates a blacker rather than whiter color.","     outColor = vec4((1.0 - cr.r) - alpha, (1.0 - cga.g) - alpha, (1.0 - cb.b) - alpha, cga.a);","     //outColor = vec4(0.0, 1.0, 0.0, 1.0);","   }","   else {","     outColor = vec4(cr.r, cga.g, cb.b, cga.a);","     //outColor = vec4(1.0, 0.0, 0.0, 1.0);","   }","   // Multiply alpha by original spriteIndexData's alpha value.","   // this will be 0 for texels not within any 'sprite' area.","   outColor.a = outColor.a * spriteIndexData.a;","   gl_FragColor = outColor;","}"].join("\n"),d=["varying vec2 vTexCoord;","void main() {","vTexCoord = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n");t.MappedMaterial=function(t,e,i){this.init(t,e,i)},t.MappedMaterial.prototype=function(){function e(){for(var t in this.userDefinedUniforms)if(this.userDefinedUniforms.hasOwnProperty(t))for(var e=0;e<this.mapper.texts.length;e++){var i=this.mapper.texts[e],o=this.userDefinedUniforms[t];if(-1==s.UniformTypes.indexOf(o.type))return void r.logError("Blotter.MappedMaterial","user defined uniforms must be one of type: "+s.UniformTypes.join(", "));if(!s.validValueForUniformType(o.type,o.value))return void r.logError("Blotter.MappedMaterial","user defined uniform value for "+t+" is incorrect for type: "+o.type);this.textsUniformsValues[i.id]=this.textsUniformsValues[i.id]||{},this.textsUniformsValues[i.id][t]=JSON.parse(JSON.stringify(o))}}function i(t){var e,i=this,r=a.call(this);h.call(i,function(o){p.call(i,function(n){e={uTime:{type:"f",value:1},uSampler:{type:"t",value:i.textsTexture},spriteIndices:{type:"t",value:o},textSpriteBoundsTexture:{type:"t",value:n},canvasWidth:{type:"f",value:i.ratioAdjustedWidth},canvasHeight:{type:"f",value:i.ratioAdjustedHeight},lenseWeight:{type:"f",value:.9}};for(var a in r)e[a]=r[a];t(e)})})}function n(t){return t+"Texture"}function a(){var t={};for(var e in this.userDefinedUniforms)t[n.call(this,e)]={value:f.call(this,e),type:"t"};return t}function h(t){var e=this;u.call(this,function(i){var r=new THREE.DataTexture(i,e.mapper.width*e.fidelityModifier,e.mapper.height*e.fidelityModifier,THREE.RGBAFormat,THREE.FloatType);r.flipY=!0,r.needsUpdate=!0,t(r)})}function u(t){var e=this,i=this.mapper.height*this.fidelityModifier,r=this.mapper.width*this.fidelityModifier,o=new Float32Array(i*r*4),n=r%1,a=1/this.mapper.texts.length/2;setTimeout(function(){for(var i=1;i<o.length/4;i++){for(var s=Math.ceil(i/(r-n)),h=i-(r-n)*(s-1),l=0,d=0,u=0,p=0;p<e.mapper.texts.length;p++){var c=e.mapper.texts[p],f=e.mapper.sizeForText(c),m=f.fit.y*e.fidelityModifier,g=f.fit.x*e.fidelityModifier,x=f.h*e.fidelityModifier,v=f.w*e.fidelityModifier;if(s>=m&&m+x>=s&&h>=g&&g+v>=h){l=p/e.mapper.texts.length+a,u=1;break}}var w=i-1;o[4*w+0]=l,o[4*w+1]=d,o[4*w+2]=d,o[4*w+3]=u}t(o)},1)}function p(t){var e=this;c.call(this,function(i){var r=new THREE.DataTexture(i,e.mapper.texts.length,1,THREE.RGBAFormat,THREE.FloatType);r.needsUpdate=!0,t(r)})}function c(t){var e=this,i=new Float32Array(4*this.mapper.texts.length);setTimeout(function(){for(var r=0;r<e.mapper.texts.length;r++){var o=e.mapper.texts[r],n=e.mapper.sizeForText(o);i[4*r]=n.fit.x*e.pixelRatio,i[4*r+1]=e.ratioAdjustedHeight-(n.fit.y+n.h)*e.pixelRatio,i[4*r+2]=n.w*e.pixelRatio,i[4*r+3]=n.h*e.pixelRatio}t(i)},1)}function f(t){var e=this.userDefinedUniforms[t],i=new Float32Array(4*this.mapper.texts.length);e||r.logError("Blotter.Composer","cannot find uniformName for _uniformTextureForUniformName");for(var o=0;o<this.mapper.texts.length;o++){var n=this.mapper.texts[o],a=this.textsUniformsValues[n.id];if(a){var s=a[t];switch(s.type){case"1f":i[4*o]=s.value,i[4*o+1]=0,i[4*o+2]=0,i[4*o+3]=0;break;case"2f":i[4*o]=s.value[0],i[4*o+1]=s.value[1],i[4*o+2]=0,i[4*o+3]=0;break;case"3f":i[4*o]=s.value[0],i[4*o+1]=s.value[1],i[4*o+2]=s.value[2],i[4*o+3]=0;break;case"4f":i[4*o]=s.value[0],i[4*o+1]=s.value[1],i[4*o+2]=s.value[2],i[4*o+3]=s.value[3];break;default:i[4*o]=0,i[4*o+1]=0,i[4*o+2]=0,i[4*o+3]=0}}else i[4*o]=0,i[4*o+1]=0,i[4*o+2]=0,i[4*o+3]=0}var h=new THREE.DataTexture(i,this.mapper.texts.length,1,THREE.RGBAFormat,THREE.FloatType);return h.needsUpdate=!0,h}return{constructor:t.MappedMaterial,init:function(t,i,r){r=r||{},this.mapper=t,this.userDefinedUniforms=r.uniforms||{},this.fidelityModifier=.5,this.pixelRatio=o.pixelRatio(),this.width=this.mapper.width,this.height=this.mapper.height,this.ratioAdjustedWidth=this.width*this.pixelRatio,this.ratioAdjustedHeight=this.height*this.pixelRatio,this.textsUniformsValues={},e.call(this)},load:function(t){var e=this,r=new THREE.TextureLoader,o=this.mapper.getImage();r.load(o,function(r){e.textsTexture=r,e.textsTexture.generateMipmaps=!1,e.textsTexture.minFilter=THREE.LinearFilter,e.textsTexture.magFilter=THREE.LinearFilter,e.textsTexture.needsUpdate=!0,i.call(e,function(i){e.threeMaterial=new THREE.ShaderMaterial({vertexShader:d,fragmentShader:l,uniforms:i}),e.threeMaterial.depthTest=!1,e.threeMaterial.depthWrite=!1,t()})})},updateUniformValueForText:function(t,e,i){var o=this,a=this.textsUniformsValues[t.id];return a?a[e]?s.validValueForUniformType(a[e].type,i)?(a[e].value=i,void setTimeout(function(){o.threeMaterial.uniforms[n.call(o,e)]={type:"t",value:f.call(o,e)},o.threeMaterial.needsUpdate=!0},1)):void r.logError("Blotter.MappedMaterial","user defined uniform value for "+e+" is incorrect for type: "+this.userDefinedUniforms[e].type):void r.logError("Blotter.MappedMaterial","cannot find uniformName for updateUniformsForText"):void r.logError("Blotter.MappedMaterial","cannot find text for updateUniformsForText")}}}(),this.Blotter=t}();