GrowingPacker=function(){},GrowingPacker.prototype={fit:function(e){var t,i,r,o=e.length,n=o>0?e[0].w:0,a=o>0?e[0].h:0;for(this.root={x:0,y:0,w:n,h:a},t=0;o>t;t++)r=e[t],(i=this.findNode(this.root,r.w,r.h))?r.fit=this.splitNode(i,r.w,r.h):r.fit=this.growNode(r.w,r.h)},findNode:function(e,t,i){return e.used?this.findNode(e.right,t,i)||this.findNode(e.down,t,i):t<=e.w&&i<=e.h?e:null},splitNode:function(e,t,i){return e.used=!0,e.down={x:e.x,y:e.y+i,w:e.w,h:e.h-i},e.right={x:e.x+t,y:e.y,w:e.w-t,h:i},e},growNode:function(e,t){var i=e<=this.root.w,r=t<=this.root.h,o=r&&this.root.h>=this.root.w+e,n=i&&this.root.w>=this.root.h+t;return o?this.growRight(e,t):n?this.growDown(e,t):r?this.growRight(e,t):i?this.growDown(e,t):null},growRight:function(e,t){return this.root={used:!0,x:0,y:0,w:this.root.w+e,h:this.root.h,down:this.root,right:{x:this.root.w,y:0,w:e,h:this.root.h}},(node=this.findNode(this.root,e,t))?this.splitNode(node,e,t):null},growDown:function(e,t){return this.root={used:!0,x:0,y:0,w:this.root.w,h:this.root.h+t,down:{x:0,y:this.root.h,w:this.root.w,h:t},right:this.root},(node=this.findNode(this.root,e,t))?this.splitNode(node,e,t):null}};var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(t){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var e=document.createElement("div");return e.id="webgl-error-message",e.style.fontFamily="monospace",e.style.fontSize="13px",e.style.fontWeight="normal",e.style.textAlign="center",e.style.background="#fff",e.style.color="#000",e.style.padding="1.5em",e.style.width="400px",e.style.margin="5em auto 0",this.webgl||(e.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),e},addGetWebGLMessage:function(e){var t,i,r;e=e||{},t=void 0!==e.parent?e.parent:document.body,i=void 0!==e.id?e.id:"oldie",r=Detector.getWebGLErrorMessage(),r.id=i,t.appendChild(r)}};"object"==typeof module&&(module.exports=Detector),!function(){for(var e,t,r={version:"1.0.0"},o=["ms","moz","webkit","o"],n=0;n<o.length&&!window.requestAnimationFrame;++n)e=window[o[n]+"RequestAnimationFrame"],t=window[o[n]+"CancelAnimationFrame"]||window[o[n]+"CancelRequestAnimationFrame"];if(!e){var a=0;e=function(e,t){var i=(new Date).getTime(),r=Math.max(0,16-(i-a)),o=window.setTimeout(function(){e(i+r)},r);return a=i+r,o}}t||(t=function(e){clearTimeout(e)});var s=function(){return this.pixelRatio||function(){var e=2,t=document.createElement("canvas").getContext("2d"),i=window.devicePixelRatio||1,r=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return i/r*e}()},h=function(e,t,i){i=i||s();var r=document.createElement("canvas");return r.width=e*i,r.height=t*i,r.style.width=e+"px",r.style.height=t+"px",r.getContext("2d").setTransform(i,0,0,i,0,0),r},d=function(e,t){console.error(e+": "+t)};r.TextDescription=function(e){this.init.apply(this,arguments)},r.TextDescription.prototype=function(){function e(e){var t=[0,0,0,0],i=(e||"").match(/\d+\w*/);if(i)switch(i=i.slice(0,4),i.length){case 1:var r=i[0];t=[r,r,r,r];break;case 2:var o=i[0],n=i[1];t=[o,n,o,n];break;case 3:var a=i[0],n=i[1],s=i[2];t=[a,n,s,n];break;default:var a=i[0],h=i[1],s=i[2],d=i[3];t=[a,h,s,d]}return t}function t(e){var t=0;if(e){if("string"==typeof e||e instanceof String){var i=e.match(/\d+/);i&&(e=i[0])}t=parseFloat(e)}return t}return{init:function(i){var r=e(i.padding);t(i.lineHeight);this.fontFamily=i.fontFamily,this.fontSize=i.fontSize,this.paddingTop=t(i.paddingTop||r[0]),this.paddingRight=t(i.paddingRight||r[1]),this.paddingBottom=t(i.paddingBottom||r[2]),this.paddingLeft=t(i.paddingLeft||r[3]),this.lineHeight=t(i.lineHeight),this.fillStyle=i.color}}}(),blotter_getTextSize=function(e,t,i){var r,o=document.createElement("p");return o.innerHTML=e,o.style.fontFamily=t,o.style.fontSize=i,o.style.visibility="hidden",o.style.display="inline-block",document.body.appendChild(o),r={w:$(o).width(),h:$(o).height()},document.body.removeChild(o),r};var c=function(e,t){this.init.apply(this,arguments)};c.prototype={init:function(e,t){e instanceof r.TextDescription||d("blotter_textureMapper","second argument must be of type Blotter.TextDescription"),this.textDescriber=e,this.texts={},this.textsKeys=[],this.addTexts(t)},addTexts:function(e){this.updateTexts(e,function(e){-1==this.textsKeys.indexOf(e)&&(this.texts[e]=this.textSizeForText(e))})},removeTexts:function(e){this.updateTexts(e,function(e){-1!=this.textsKeys.indexOf(e)&&delete this.texts[e]})},updateTexts:function(e,t){("string"==typeof e||e instanceof String)&&(e=[e]);for(var i=0;i<e.length;i++)t.apply(this,[e[i]]);this.textsKeys=Object.keys(this.texts),this.determineTextsMapping()},textSizeForText:function(e){var t=blotter_getTextSize(e,this.textDescriber.fontFamily,this.textDescriber.fontSize);return t.w+=this.textDescriber.paddingLeft+this.textDescriber.paddingRight,t.h+=this.textDescriber.paddingTop+this.textDescriber.paddingBottom,t},determineTextsMapping:function(){var e=this,t=new GrowingPacker,i=this.textsKeys.map(function(t){var i=e.texts[t];return i.key=t,i},e).sort(this.sortTexts);t.fit(i);for(var r in this.texts){var o=this.texts[r];e.texts[o.key]=o,delete o.key}var n=this.nearestPowerOfTwo(Math.max(t.root.w,t.root.h));this.width=n,this.height=n},sortTexts:function(e,t){var i=e.w*e.h,r=t.w*t.h;return r>i?1:i>r?-1:0},nearestPowerOfTwo:function(e){for(var t=[8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768],i=t[t.length-1],r=0;r<t.length;r++){var o=t[r+1];t[r]<e&&o>=e&&(i=o)}return i},getCanvas:function(){var e=h(this.width,this.height),t=e.getContext("2d");for(var i in this.texts){var r=this.texts[i],o=(r.h*this.textDescriber.lineHeight-r.h)/2;t.font=this.textDescriber.fontSize+" "+this.textDescriber.fontFamily,t.fillStyle=this.textDescriber.fillStyle,t.fillText(i,r.fit.x+this.textDescriber.paddingLeft,r.fit.y+this.textDescriber.paddingTop+o)}return e},getImage:function(){return this.getCanvas().toDataURL()}};var f=["precision highp float;","uniform sampler2D uSampler;","uniform sampler2D spriteIndices;","uniform sampler2D spriteDataTexture;","uniform float uTime;","uniform float canvasWidth;","uniform float canvasHeight;","uniform float lenseWeight;","varying vec2 vTexCoord;","void main(void) {","   vec2 aspect = vec2(canvasWidth, canvasHeight).xy;","   vec4 spriteIndexData = texture2D(spriteIndices, vTexCoord);","   float spriteIndex = spriteIndexData.x;","   vec4 spriteData = texture2D(spriteDataTexture, vec2(spriteIndex, 0.5));","   // p = x, y percentage for texel position within of total resolution","   vec2 p = (gl_FragCoord.xy - spriteData.rg) / spriteData.ba;","   // m = x, y percentage for center position within total resolution","   // note: you should know this, but swizzling allows access to vecN data using x,y,z, and w (or r, g, b, and a) in that order.","   //vec4 centerPointsData = texture2D(centerPointsTexture, vec2(spriteIndex, 0.5));","   //vec2 m = centerPointsData.xy;","   vec2 m = vec2(0.5);","   // d = difference between p and m (obviously, but see above).","   vec2 d = p - m;","   // The dot function returns the dot product of the two","   // input parameters, i.e. the sum of the component-wise","   // products. If x and y are the same the square root of","   // the dot product is equivalent to the length of the vector.","   // Therefore, r = length of vector represented by d (the ","   // distance of the texel from center position).","   // In order to apply weights here, we add our weight to this distance","   // (pushing it closer to 1 - essentially giving no effect at all) and","   // find the min between our weighted distance and 1.0","   float inverseLenseWeight = 1.0 - lenseWeight;","   float r = min(sqrt(dot(d, d)) + inverseLenseWeight, 1.0);","   vec2 offsetUV = m + (d * r);","   vec2 adjustedFragCoord = spriteData.rg + vec2((spriteData.b * offsetUV.x), (spriteData.a * offsetUV.y));","   //adjustedFragCoord.x = clamp(adjustedFragCoord.x, spriteData.r, (spriteData.r + spriteData.b));","   //adjustedFragCoord.y = clamp(adjustedFragCoord.y, spriteData.g, (spriteData.g + spriteData.a));","   vec2 uv = adjustedFragCoord.xy / aspect;","   // RGB shift","   vec2 offset = vec2(0.0);","   if (r < 1.0) {","     float amount = 0.0013;","     float angle = 0.45;","     offset = (amount * (1.0 - r)) * vec2(cos(angle), sin(angle));","   }","   vec4 cr = texture2D(uSampler, (uv + offset));","   vec4 cga = texture2D(uSampler, uv);","   vec4 cb = texture2D(uSampler, (uv - offset));","   vec4 outColor = vec4(0.0);","   if (cr.r > 0.0 || cga.g > 0.0 || cb.b > 0.0) {","     // Adjust rgb values so that colors with transparency appear as if they were atop an opaque white background.","     // (vec4(0.0, 0.0, 0.0, 0.5) _atop white_ is visibly the same as vec4(0.5, 0.5, 0.5, 0.0))","     if (cr.a != 0.0) {","       cr.r = cr.r + cr.a;","     }","     if (cga.a != 0.0) {","       cga.g = cga.g + cga.a;","     }","     if (cb.b != 0.0) {","       cb.b = cb.b + cb.a;","     }","     // Ensure offseted/shifted texels have alpha similar to the texel they are offsetting","     // (this prevents texel from being invisible if cga.a = vec4(0.0, 0.0, 0.0, 0.0)","     cga.a = max(cga.a, max(cr.a, cb.a));","     // Set alpha adjustment value so that white texels keep their transparency.","   	float alpha = 1.0 - cga.a;","     // Invert colors (this is cheating but optimal) so that we have CMYK rather than RGB","     // shifted colors and the combination of offsets creates a blacker rather than whiter color.","     outColor = vec4((1.0 - cr.r) - alpha, (1.0 - cga.g) - alpha, (1.0 - cb.b) - alpha, cga.a);","   }","   else {","     outColor = vec4(cr.r, cga.g, cb.b, cga.a);","   }","   // Multiply alpha by original spriteIndexData's alpha value.","   // this will be 0 for texels not within any 'sprite' area.","   outColor.a = outColor.a * spriteIndexData.a;","   gl_FragColor = outColor;","}"].join("\n"),u=["varying vec2 vTexCoord;","void main() {","vTexCoord = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),l=["1f","2f","3f","4f"];r.MappedRenderer=function(e,t,i,r){this.init(e,t,i)},r.MappedRenderer.prototype=function(){return{constructor:r.MappedRenderer,init:function(e,t,i,r){r=r||{},this.$canvasRegion=e,this.textDescriber=t,this.mapper=this.createMapper(t,i),this.userDefinedUniforms=r.uniforms||{},this.textsKeys=this.mapper.textsKeys,this.pixelRatio=s(),this.ratioAdjustedWidth=this.mapper.width*this.pixelRatio,this.ratioAdjustedHeight=this.mapper.height*this.pixelRatio},createMapper:function(e,t){return e instanceof r.TextDescription?new c(e,t):void d("blotter_renderer","first argument must be of type Blotter.TextDescription")},build:function(e){var t=this,i=new THREE.TextureLoader,r=this.mapper.getImage();i.load(r,function(i){Detector.webgl||d("blotter_Renderer","device does not support webgl"),t.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),t.renderer.setSize(t.ratioAdjustedWidth,t.ratioAdjustedHeight),t.scene=new THREE.Scene,t.camera=new THREE.Camera,t.geometry=new THREE.PlaneGeometry(2,2,0),t.textsTexture=i,t.textsTexture.needsUpdate=!0,t.canvas=t.renderer.domElement,$(t.canvas).css({width:t.mapper.width,height:t.mapper.height}),$(t.canvas).attr({width:t.ratioAdjustedWidth,height:t.ratioAdjustedHeight}),t.$canvasRegion.html(t.canvas),t.materialUniforms(function(i){t.material=new THREE.ShaderMaterial({vertexShader:u,fragmentShader:f,uniforms:i}),t.material.depthTest=!1,t.material.depthWrite=!1,t.mesh=new THREE.Mesh(t.geometry,t.material),t.scene.add(t.mesh),e()})})},start:function(){this.lastDrawTime=Date.now(),this.currentAnimationLoop||this.loop()},spriteIndicesTexture:function(e){var t=.5;this.spriteIndices(_.bind(function(i){var r=new THREE.DataTexture(i,this.mapper.width*t,this.mapper.height*t,THREE.RGBAFormat,THREE.FloatType);r.flipY=!0,r.needsUpdate=!0,e(r)},this),t)},spriteIndices:function(e,t){var t=t||1,r=this.mapper.height*t,o=this.mapper.width*t,n=new Float32Array(r*o*4),a=o%1,s=1/this.mapper.textsKeys.length/2;setTimeout(_.bind(function(){for(i=1;i<n.length/4;i++){var r=Math.ceil(i/(o-a)),h=i-(o-a)*(r-1),d=0,c=0;for(ki=0;ki<this.mapper.textsKeys.length;ki++){var f=this.mapper.texts[this.mapper.textsKeys[ki]],u=f.fit.y*t,l=f.fit.x*t,p=f.h*t,m=f.w*t;if(r>=u&&u+p>=r&&h>=l&&l+m>=h){d=ki/this.mapper.textsKeys.length+s,c=1;break}}var g=i-1;n[4*g+0]=d,n[4*g+1]=d,n[4*g+2]=d,n[4*g+3]=c}e(n)},this),1)},spriteDataTexture:function(e){this.spriteDataArray(_.bind(function(t){var i=new THREE.DataTexture(t,this.mapper.textsKeys.length,1,THREE.RGBAFormat,THREE.FloatType);i.needsUpdate=!0,e(i)},this))},spriteDataArray:function(e){var t=new Float32Array(4*this.mapper.textsKeys.length),i=0;setTimeout(_.bind(function(){$.each(this.mapper.texts,_.bind(function(e,r){t[4*i]=r.fit.x*this.pixelRatio,t[4*i+1]=this.canvas.height-(r.fit.y+r.h)*this.pixelRatio,t[4*i+2]=r.w*this.pixelRatio,t[4*i+3]=r.h*this.pixelRatio,i++},this)),e(t)},this),1)},materialUniforms:function(e){var t,i=this,r=this.uniformsForUserDefinedUniformValues();this.spriteIndicesTexture(_.bind(function(o){this.spriteDataTexture(_.bind(function(n){t={uTime:{type:"f",value:1},uSampler:{type:"t",value:i.textsTexture},spriteIndices:{type:"t",value:o},spriteDataTexture:{type:"t",value:n},canvasWidth:{type:"f",value:i.canvas.width},canvasHeight:{type:"f",value:i.canvas.height},lenseWeight:{type:"f",value:.9}};for(var a in r)t[a]=r[a];e(t)},this))},this))},uniformTextureNameForUniformName:function(e){return e+"Texture"},uniformsForUserDefinedUniformValues:function(){var e={};this.textUniformValues={};for(var t in this.userDefinedUniforms){if(this.userDefinedUniforms.hasOwnProperty(t))for(var i=0;i<this.mapper.textsKeys.length;i++){var r=this.userDefinedUniforms[t];if(-1==l.indexOf(r.type))return void d("blotter_Renderer","user defined uniforms must be one of type: "+l.join(", "));if(!this.isValidValueForType(r.type,r.value))return void d("blotter_Renderer","user defined uniform value for "+t+" is incorrect for type: "+r.type);this.textUniformValues[this.mapper.textsKeys[i]][t]=r.value}e[this.uniformTextureNameForUniformName(t)]=this.uniformTextureForUniformName(t)}return e},updateUniformValueForText:function(e,t,i){return this.textUniformValues[e]?this.textUniformValues[e][t]?this.isValidValueForType(this.userDefinedUniforms[t].type,i)?(this.textUniformValues[e][t]=i,void(this.material&&(this.material.uniforms[this.uniformTextureNameForUniformName(t)]=this.uniformTextureForUniformName(t)))):void d("blotter_Renderer","user defined uniform value for "+t+" is incorrect for type: "+this.userDefinedUniforms[t].type):void d("blotter_Renderer","cannot find uniformName for updateUniformsForText"):void d("blotter_Renderer","cannot find text for updateUniformsForText")},uniformTextureForUniformName:function(e){var t=this.userDefinedUniforms[e],i=new Float32Array(4*this.mapper.textsKeys.length);t||d("blotter_Renderer","cannot find uniformName for buildUniformTexture");for(var r=0;r<this.mapper.textsKeys.length;r++){var o=this.textUniformValues[this.mapper.textsKeys[r]][e];switch(t.type){case"1f":i[4*r]=o,i[4*r+1]=0,i[4*r+2]=0,i[4*r+3]=0;break;case"2f":i[4*r]=o[0],i[4*r+1]=o[1],i[4*r+2]=0,i[4*r+3]=0;break;case"3f":i[4*r]=o[0],i[4*r+1]=o[1],i[4*r+2]=o[2],i[4*r+3]=0;break;case"4f":i[4*r]=o[0],i[4*r+1]=o[1],i[4*r+2]=o[2],i[4*r+3]=o[3]}}var n=new THREE.DataTexture(i,this.mapper.textsKeys.length,1,THREE.RGBAFormat,THREE.FloatType);return n.needsUpdate=!0,n},isValidValueForType:function(e,t){var i=!1;switch(e){case"1f":i=!isNaN(t);break;case"2f":i=Array.isArray(t)&&2==t.length;break;case"3f":i=Array.isArray(t)&&3==t.length;break;case"4f":i=Array.isArray(t)&&4==t.length}return i},loop:function(){this.renderer.render(this.scene,this.camera),this.currentAnimationLoop=e(_.bind(function(){this.loop()},this))},stop:function(){this.currentAnimationLoop&&(t(this.currentAnimationLoop),this.currentAnimationLoop=void 0)},teardown:function(){this.stop(),this.renderer=null,$(this.canvas).remove()}}}(),this.BLOTTER=r}();