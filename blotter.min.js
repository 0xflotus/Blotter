Object.keys||(Object.keys=function(){"use strict";var t=Object.prototype.hasOwnProperty,e=!{toString:null}.propertyIsEnumerable("toString"),i=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],r=i.length;return function(n){if("object"!=typeof n&&("function"!=typeof n||null===n))throw new TypeError("Object.keys called on non-object");var o,s,a=[];for(o in n)t.call(n,o)&&a.push(o);if(e)for(s=0;r>s;s++)t.call(n,i[s])&&a.push(i[s]);return a}}()),GrowingPacker=function(){},GrowingPacker.prototype={fit:function(t){var e,i,r,n=t.length,o=n>0?t[0].w:0,s=n>0?t[0].h:0;for(this.root={x:0,y:0,w:o,h:s},e=0;n>e;e++)r=t[e],(i=this.findNode(this.root,r.w,r.h))?r.fit=this.splitNode(i,r.w,r.h):r.fit=this.growNode(r.w,r.h)},findNode:function(t,e,i){return t.used?this.findNode(t.right,e,i)||this.findNode(t.down,e,i):e<=t.w&&i<=t.h?t:null},splitNode:function(t,e,i){return t.used=!0,t.down={x:t.x,y:t.y+i,w:t.w,h:t.h-i},t.right={x:t.x+e,y:t.y,w:t.w-e,h:i},t},growNode:function(t,e){var i=t<=this.root.w,r=e<=this.root.h,n=r&&this.root.h>=this.root.w+t,o=i&&this.root.w>=this.root.h+e;return n?this.growRight(t,e):o?this.growDown(t,e):r?this.growRight(t,e):i?this.growDown(t,e):null},growRight:function(t,e){this.root={used:!0,x:0,y:0,w:this.root.w+t,h:this.root.h,down:this.root,right:{x:this.root.w,y:0,w:t,h:this.root.h}};var i=this.findNode(this.root,t,e);return i?this.splitNode(i,t,e):null},growDown:function(t,e){this.root={used:!0,x:0,y:0,w:this.root.w,h:this.root.h+e,down:{x:0,y:this.root.h,w:this.root.w,h:e},right:this.root};var i=this.findNode(this.root,t,e);return i?this.splitNode(i,t,e):null}};var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var t=document.createElement("canvas");return!(!window.WebGLRenderingContext||!t.getContext("webgl")&&!t.getContext("experimental-webgl"))}catch(e){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var t=document.createElement("div");return t.id="webgl-error-message",t.style.fontFamily="monospace",t.style.fontSize="13px",t.style.fontWeight="normal",t.style.textAlign="center",t.style.background="#fff",t.style.color="#000",t.style.padding="1.5em",t.style.width="400px",t.style.margin="5em auto 0",this.webgl||(t.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),t},addGetWebGLMessage:function(t){var e,i,r;t=t||{},e=void 0!==t.parent?t.parent:document.body,i=void 0!==t.id?t.id:"oldie",r=Detector.getWebGLErrorMessage(),r.id=i,e.appendChild(r)}};"object"==typeof module&&(module.exports=Detector),function(){"use strict";function t(){}function e(t,e){for(var i=t.length;i--;)if(t[i].listener===e)return i;return-1}function i(t){return function(){return this[t].apply(this,arguments)}}var r=t.prototype,n=this,o=n.EventEmitter;r.getListeners=function(t){var e,i,r=this._getEvents();if(t instanceof RegExp){e={};for(i in r)r.hasOwnProperty(i)&&t.test(i)&&(e[i]=r[i])}else e=r[t]||(r[t]=[]);return e},r.flattenListeners=function(t){var e,i=[];for(e=0;e<t.length;e+=1)i.push(t[e].listener);return i},r.getListenersAsObject=function(t){var e,i=this.getListeners(t);return i instanceof Array&&(e={},e[t]=i),e||i},r.addListener=function(t,i){var r,n=this.getListenersAsObject(t),o="object"==typeof i;for(r in n)n.hasOwnProperty(r)&&-1===e(n[r],i)&&n[r].push(o?i:{listener:i,once:!1});return this},r.on=i("addListener"),r.addOnceListener=function(t,e){return this.addListener(t,{listener:e,once:!0})},r.once=i("addOnceListener"),r.defineEvent=function(t){return this.getListeners(t),this},r.defineEvents=function(t){for(var e=0;e<t.length;e+=1)this.defineEvent(t[e]);return this},r.removeListener=function(t,i){var r,n,o=this.getListenersAsObject(t);for(n in o)o.hasOwnProperty(n)&&(r=e(o[n],i),-1!==r&&o[n].splice(r,1));return this},r.off=i("removeListener"),r.addListeners=function(t,e){return this.manipulateListeners(!1,t,e)},r.removeListeners=function(t,e){return this.manipulateListeners(!0,t,e)},r.manipulateListeners=function(t,e,i){var r,n,o=t?this.removeListener:this.addListener,s=t?this.removeListeners:this.addListeners;if("object"!=typeof e||e instanceof RegExp)for(r=i.length;r--;)o.call(this,e,i[r]);else for(r in e)e.hasOwnProperty(r)&&(n=e[r])&&("function"==typeof n?o.call(this,r,n):s.call(this,r,n));return this},r.removeEvent=function(t){var e,i=typeof t,r=this._getEvents();if("string"===i)delete r[t];else if(t instanceof RegExp)for(e in r)r.hasOwnProperty(e)&&t.test(e)&&delete r[e];else delete this._events;return this},r.removeAllListeners=i("removeEvent"),r.emitEvent=function(t,e){var i,r,n,o,s,a=this.getListenersAsObject(t);for(o in a)if(a.hasOwnProperty(o))for(i=a[o].slice(0),n=i.length;n--;)r=i[n],r.once===!0&&this.removeListener(t,r.listener),s=r.listener.apply(this,e||[]),s===this._getOnceReturnValue()&&this.removeListener(t,r.listener);return this},r.trigger=i("emitEvent"),r.emit=function(t){var e=Array.prototype.slice.call(arguments,1);return this.emitEvent(t,e)},r.setOnceReturnValue=function(t){return this._onceReturnValue=t,this},r._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},r._getEvents=function(){return this._events||(this._events={})},t.noConflict=function(){return n.EventEmitter=o,t},"function"==typeof define&&define.amd?define(function(){return t}):"object"==typeof module&&module.exports?module.exports=t:n.EventEmitter=t}.call(this),!function(){var t={version:"0.1.0"},e=["ms","moz","webkit","o"],i=function(){for(var t=0,i=window.requestAnimationFrame,r=window.cancelAnimationFrame,n=e,o=0;o<n.length&&!i;++o)i=window[n[o]+"RequestAnimationFrame"],r=window[n[o]+"CancelAnimationFrame"]||window[n[o]+"CancelRequestAnimationFrame"];return i||(i=function(e,i){var r=(new Date).getTime(),n=Math.max(0,16-(r-t)),o=window.setTimeout(function(){e(r+n)},n);return t=r+n,o}),r||(r=function(t){clearTimeout(t)}),{requestAnimationFrame:function(t){return i.call(window,t)},cancelAnimationFrame:function(t){r.call(window,t)}}}(),r=function(t,e){this.init(t,e)};r.prototype=function(){function t(t,e){this.cache=[];for(var i=0;e>i;i++)this.cache.push(new Float32Array(t))}return{constructor:r,init:function(e,i){i=i||10,this.index=0,t.call(this,e,i)},next:function(){return this.current=this.cache[this.index],this.index++,this.index==this.cache.length&&(this.index=0),this.current}}}();var n=function(t,e,i){this.init(t,e,i)};n.prototype=function(){function t(t,e,i){var r=document.createElement("canvas"),n=r.getContext("2d");this.cache=[];for(var o=0;i>o;o++)this.cache.push(n.createImageData(t,e));delete r}return{constructor:n,init:function(e,i,r){r=r||10,this.index=0,t.call(this,e,i,r)},next:function(){return this.current=this.cache[this.index],this.index++,this.index==this.cache.length&&(this.index=0),this.current}}}();var o=function(t,e){this.init(t,e)};o.prototype=function(){function t(t,e){this.cache=[];for(var i=0;e>i;i++)this.cache.push(new Uint8Array(t))}return{constructor:o,init:function(e,i){i=i||10,this.index=0,t.call(this,e,i)},next:function(){return this.current=this.cache[this.index],this.index++,this.index==this.cache.length&&(this.index=0),this.current}}}();var s={canvas:function(t,e){var i=document.createElement("canvas");return i.width=t,i.height=e,i},hiDpiCanvas:function(t,e,i){i=i||this.pixelRatio;var r=document.createElement("canvas");return r.width=t*i,r.height=e*i,r.style.width=t+"px",r.style.height=e+"px",r.getContext("2d").setTransform(i,0,0,i,0,0),r},pixelRatio:function(){var t=1;console.log("dont forget you did this. set back to 1");for(var i=document.createElement("canvas").getContext("2d"),r=window.devicePixelRatio||1,n=i.backingStorePixelRatio,o=0;o<e.length&&!n;++o)n=i[e[o]+"BackingStorePixelRatio"];return n=n||1,r/n*t}(),mousePosition:function(t,e){var i=t.getBoundingClientRect();return{x:e.clientX-i.left,y:e.clientY-i.top}},normalizedMousePosition:function(t,e){var i=t.getBoundingClientRect(),r=this.mousePosition(t,e);return{x:r.x/i.width,y:r.y/i.height}}},a=function(){function t(t,e){return t+": "+e}return{logError:function(e,i){var r=t(e,i);console.error(r)},throwError:function(e,i){var r=t(e,i);throw r}}}(),h={family:"sans-serif",size:12,leading:1.5,fill:"#000",style:"normal",weight:500,padding:0,paddingTop:0,paddingRight:0,paddingBottom:0,paddingLeft:0},u={Properties:function(){return Object.keys(h)}(),ensurePropertyValues:function(t){for(var e=t||{},i=h,r=0;r<this.Properties.length;r++){var n=this.Properties[r];n in e&&(i[n]=e[n])}return i},stringifiedPadding:function(t){var e=t||this.ensurePropertyValues(),i=t.paddingTop||e.padding,r=e.paddingRight||e.padding,n=e.paddingBottom||e.padding,o=e.paddingLeft||e.padding;return i+"px "+r+"px "+n+"px "+o+"px"},sizeForText:function(t,e){var i,r=document.createElement("p"),e=this.ensurePropertyValues(e);return r.innerHTML=t,r.style.fontFamily=e.family,r.style.fontSize=e.size+"px",r.style.fontWeight=e.weight,r.style.fontStyle=e.style,r.style.padding=this.stringifiedPadding(e),r.style.lineHeight=e.leading,r.style.visibility="hidden",r.style.display="inline-block",document.body.appendChild(r),i={w:r.offsetWidth,h:r.offsetHeight},document.body.removeChild(r),i}},l={UniformTypes:["1f","2f","3f","4f"],validValueForUniformType:function(t,e){var i=!1,r=function(t,e,i){return!isNaN(t)};switch(t){case"1f":i=!isNaN(e)&&[e].every(r);break;case"2f":i=Array.isArray(e)&&2==e.length&&e.every(r);break;case"3f":i=Array.isArray(e)&&3==e.length&&e.every(r);break;case"4f":i=Array.isArray(e)&&4==e.length&&e.every(r)}return i},glslDataTypeForUniformType:function(t){var e;switch(t){case"1f":e="float";break;case"2f":e="vec2";break;case"3f":e="vec3";break;case"4f":e="vec4"}return e},fullSwizzleStringForUniformType:function(t){var e;switch(t){case"1f":e="x";break;case"2f":e="xy";break;case"3f":e="xyz";break;case"4f":e="xyzw"}return e}};t.Text=function(t,e){this.init(t,e)},t.Text.prototype=function(){return{constructor:t.Text,init:function(t,e){this.id=THREE.Math.generateUUID(),this.value=t,this.properties=u.ensurePropertyValues(e)}}}();var f=function(t){this.init.apply(this,arguments)};f.prototype=function(){function e(e,r){e instanceof Array||(e=[e]);for(var n=0;n<e.length;n++){var o=e[n];e instanceof t.Text&&a.throwError("blotter_Mapper","argument must be instance of Blotter.Text or array of objects that are instances of Blotter.Text"),r.call(this,o)}i.call(this)}function i(){var t=new GrowingPacker,e=[];for(var i in this.textsSizes){var n=this.textsSizes[i];n.referenceId=i,e.push(n)}t.fit(e.sort(r));for(var o=0;o<e.length;o++){var s=e[o];this.flipY&&(s.fit.y=t.root.h-(s.fit.y+s.h)),this.textsSizes[s.referenceId].fit=s.fit}this.width=t.root.w,this.height=t.root.h}function r(t,e){var i=t.w*t.h,r=e.w*e.h;return r-i}function n(t,e){var e=e||u.ensurePropertyValues().leading;return isNaN(e)?-1!==e.toString().indexOf("px")?e=parseInt(e):-1!==e.toString().indexOf("%")&&(e=parseInt(e)/100*t):e=t*e,e}return{constructor:f,init:function(t,e){var e=e||{};this.pixelRatio=e.pixelRatio||1,this.flipY=e.flipY||!1,this.texts=[],this.textsSizes={},this.width=0,this.height=0,this.addTexts(t)},addTexts:function(t){e.call(this,t,function(t){var e=this.textsSizes[t.id];if(-1==this.texts.indexOf(t)&&this.texts.push(t),!e){var i=u.sizeForText(t.value,t.properties);this.textsSizes[t.id]=i}})},removeTexts:function(t){e.call(this,t,function(t){var e=this.texts.indexOf(t);-1!=e&&this.texts.splice(e,1),delete this.textsSizes[t.id]})},sizeForText:function(t){return this.textsSizes[t.id]},toCanvas:function(){var t=s.hiDpiCanvas(this.width,this.height,this.pixelRatio),e=t.getContext("2d",{alpha:!1});e.textBaseline="middle";for(var i=0;i<this.texts.length;i++){var r=this.texts[i],o=this.textsSizes[r.id],a=n.call(this,r.properties.size,r.properties.leading)/2,h=o.fit.y+r.properties.paddingTop+a;e.font=r.properties.style+" "+r.properties.weight+" "+r.properties.size+"px "+r.properties.family,e.save(),e.translate(o.fit.x+r.properties.paddingLeft,h),this.flipY&&e.scale(1,-1),e.fillStyle=r.properties.fill,e.fillText(r.value,0,0),e.restore()}return t},getImage:function(){return this.toCanvas().toDataURL()}}}();var c=function(t,e){this.init(t,e)};c.prototype=function(){function t(t){var e=this,i=this.mapper.height*this.fidelityModifier,r=this.mapper.width*this.fidelityModifier,n=new Float32Array(i*r*4),o=r%1,s=1/this.mapper.texts.length/2;setTimeout(function(){for(var i=1;i<n.length/4;i++){for(var a=Math.ceil(i/(r-o)),h=i-(r-o)*(a-1),u=0,l=0,f=0,c=0;c<e.mapper.texts.length;c++){var d=e.mapper.texts[c],p=e.mapper.sizeForText(d),m=p.fit.y*e.fidelityModifier,g=p.fit.x*e.fidelityModifier,v=p.h*e.fidelityModifier,x=p.w*e.fidelityModifier;if(a>=m&&m+v>=a&&h>=g&&g+x>=h){u=c/e.mapper.texts.length+s,f=1;break}}var y=i-1;n[4*y+0]=u,n[4*y+1]=l,n[4*y+2]=l,n[4*y+3]=f}t(n)},1)}return{constructor:c,init:function(t,e){this.mapper=t,this.fidelityModifier=e||.5},build:function(e){var i=this;t.call(this,function(t){var r=new THREE.DataTexture(t,i.mapper.width*i.fidelityModifier,i.mapper.height*i.fidelityModifier,THREE.RGBAFormat,THREE.FloatType);r.flipY=!0,r.needsUpdate=!0,e(r)})}}}();var d=function(t,e){this.init(t,e)};d.prototype=function(){function t(t){var e=this,i=new Float32Array(4*this.mapper.texts.length);setTimeout(function(){for(var r=0;r<e.mapper.texts.length;r++){var n=e.mapper.texts[r],o=e.mapper.sizeForText(n);i[4*r]=o.fit.x*e.pixelRatio,i[4*r+1]=e.height*e.pixelRatio-(o.fit.y+o.h)*e.pixelRatio,i[4*r+2]=o.w*e.pixelRatio,i[4*r+3]=o.h*e.pixelRatio}t(i)},1)}return{constructor:d,init:function(t,e){this.mapper=t,this.pixelRatio=e||1,this.width=this.mapper.width,this.height=this.mapper.height},build:function(e){var i=this;t.call(this,function(t){var r=new THREE.DataTexture(t,i.mapper.texts.length,1,THREE.RGBAFormat,THREE.FloatType);r.needsUpdate=!0,e(r)})}}}(),t.Material=function(t,e,i){this.init(t,e,i)},t.Material.prototype=function(){function e(t){Array.isArray(t)||(t=[t]);var e=new f(t,{pixelRatio:this.pixelRatio,flipY:!0});return this.width=e.width*this.pixelRatio,this.height=e.height*this.pixelRatio,e}function i(){var t=["varying vec2 _vTexCoord;","void main() {","  _vTexCoord = uv;","  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"];return t.join("\n")}function n(){var t,e=[],i=[],r=[];for(var n in this.userDefinedUniforms){var o=this,s=this.userDefinedUniforms[n];e.push("uniform sampler2D "+u.call(this,n)+";"),i.push(l.glslDataTypeForUniformType(s.type)+" "+n+";"),r.push(function(){var t=u.call(o,n),e=l.fullSwizzleStringForUniformType(s.type);return n+" = texture2D("+t+" , vec2(spriteIndex, 0.5))."+e+";"}())}return e=e.join("\n"),i=i.join("\n"),r=r.join("\n"),t=["precision highp float;","uniform sampler2D _uSampler;","uniform sampler2D _uSpriteIndicesTexture;","uniform sampler2D _uSpriteBoundsTexture;","uniform vec2 _uCanvasResolution;","varying vec2 _vTexCoord;","vec4 _spriteBounds;","vec2 uResolution;",e,i,"vec4 textTexture( vec2 coord ) {","   vec2 adjustedFragCoord = _spriteBounds.xy + vec2((_spriteBounds.z * coord.x), (_spriteBounds.w * coord.y));","   vec2 uv = adjustedFragCoord.xy / _uCanvasResolution;","   if (adjustedFragCoord.x < _spriteBounds.x ||","       adjustedFragCoord.x > _spriteBounds.x + _spriteBounds.z ||","       adjustedFragCoord.y < _spriteBounds.y ||","       adjustedFragCoord.y > _spriteBounds.y + _spriteBounds.w) {","     return vec4(0.0);","   }","   return texture2D(_uSampler, uv);","}","void mainImage( out vec4 mainImage, in vec2 fragCoord );",this.shaderSrc,"void main( void ) {","   vec4 spriteIndexData = texture2D(_uSpriteIndicesTexture, _vTexCoord);","   float spriteIndex = spriteIndexData.r;","   float spriteAlpha = spriteIndexData.a;","   _spriteBounds = texture2D(_uSpriteBoundsTexture, vec2(spriteIndex, 0.5));","   uResolution = _spriteBounds.zw;",r,"   vec2 fragCoord = gl_FragCoord.xy - _spriteBounds.xy;","   vec4 outColor;","   mainImage(outColor, fragCoord);","   outColor.a = outColor.a * spriteAlpha;","   gl_FragColor = outColor;//texture2D(_uSampler, _vTexCoord);//vec4(1.0, 0.6705882353, 0.2509803922, 0.7);//outColor;//vec4(1.0, 1.0, 0.5, 1.0);//","}"],t.join("\n")}function o(){for(var t in this.userDefinedUniforms)if(this.userDefinedUniforms.hasOwnProperty(t))for(var e=0;e<this.mapper.texts.length;e++){var i=this.mapper.texts[e],r=this.userDefinedUniforms[t];if(-1==l.UniformTypes.indexOf(r.type))return void a.logError("Blotter.Material","user defined uniforms must be one of type: "+l.UniformTypes.join(", "));if(!l.validValueForUniformType(r.type,r.value))return void a.logError("Blotter.Material","user defined uniform value for "+t+" is incorrect for type: "+r.type);this.textsUniformsValues[i.id]=this.textsUniformsValues[i.id]||{},this.textsUniformsValues[i.id][t]=JSON.parse(JSON.stringify(r))}}function h(t){var e,i=this,r=new THREE.TextureLoader,n=p.call(this),o=new c(this.mapper,this.fidelity),s=new d(this.mapper,this.pixelRatio);r.load(this.mapper.getImage(),function(r){o.build(function(o){s.build(function(s){r.generateMipmaps=!1,r.minFilter=THREE.LinearFilter,r.magFilter=THREE.LinearFilter,r.needsUpdate=!0,e={_uSampler:{type:"t",value:r},_uCanvasResolution:{type:"2f",value:[i.width,i.height]},_uSpriteIndicesTexture:{type:"t",value:o},_uSpriteBoundsTexture:{type:"t",value:s}};for(var a in n)e[a]=n[a];t(e)})})})}function u(t){return"_"+t+"Texture"}function p(){var t={};for(var e in this.userDefinedUniforms)t[u.call(this,e)]={value:m.call(this,e),type:"t"};return t}function m(t){var e=this.userDefinedUniforms[t],i=this.float32ArrayCache.next();e||a.logError("Blotter.Composer","cannot find uniformName for _uniformTextureForUniformName");for(var r=0;r<this.mapper.texts.length;r++){var n=this.mapper.texts[r],o=this.textsUniformsValues[n.id];if(o){var s=o[t];"1f"==s.type?(i[4*r]=s.value,i[4*r+1]=0,i[4*r+2]=0,i[4*r+3]=0):"2f"==s.type?(i[4*r]=s.value[0],i[4*r+1]=s.value[1],i[4*r+2]=0,i[4*r+3]=0):"3f"==s.type?(i[4*r]=s.value[0],i[4*r+1]=s.value[1],i[4*r+2]=s.value[2],i[4*r+3]=0):"4f"==s.type?(i[4*r]=s.value[0],i[4*r+1]=s.value[1],i[4*r+2]=s.value[2],i[4*r+3]=s.value[3]):(i[4*r]=0,i[4*r+1]=0,i[4*r+2]=0,i[4*r+3]=0)}else i[4*r]=0,i[4*r+1]=0,i[4*r+2]=0,i[4*r+3]=0}var h=new THREE.DataTexture(i,this.mapper.texts.length,1,THREE.RGBAFormat,THREE.FloatType);return h.needsUpdate=!0,h}return{constructor:t.Material,init:function(t,i,n){n=n||{},this.pixelRatio=n.pixelRatio||s.pixelRatio,this.mapper=e.call(this,t),this.float32ArrayCache=new r(4*this.mapper.texts.length),this.shaderSrc=i,this.userDefinedUniforms=n.uniforms||{},this.fidelity=.5,this.textsUniformsValues={},o.call(this)},load:function(t){var e=this;h.call(this,function(r){e.threeMaterial=new THREE.ShaderMaterial({vertexShader:i.call(e),fragmentShader:n.call(e),uniforms:r}),e.threeMaterial.depthTest=!1,e.threeMaterial.depthWrite=!1,t()})},hasText:function(e){return e instanceof t.Text||a.logError("Blotter.Material","argument must be instanceof Blotter.Text"),!!this.textsUniformsValues[e.id]},updateUniformValueForText:function(t,e,i){var r=this.textsUniformsValues[t.id];return r?r[e]?l.validValueForUniformType(r[e].type,i)?(r[e].value=i,this.threeMaterial.uniforms[u.call(self,e)]={type:"t",value:m.call(this,e)},void(this.threeMaterial.needsUpdate=!0)):void a.logError("Blotter.Material","user defined uniform value for "+e+" is incorrect for type: "+this.userDefinedUniforms[e].type):void a.logError("Blotter.Material","cannot find uniformName for updateUniformsForText"):void a.logError("Blotter.Material","cannot find text for updateUniformsForText")}}}();var p=function(t,e,i){this.init(t,e,i)};p.prototype=function(){function t(){var t=EventEmitter.prototype;for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e])}function e(){for(var t=this,e=["mousedown","mouseup","mousemove","mouseenter","mouseleave"],i=0;i<e.length;i++){var r=e[i];!function(t,e){t.domElement.addEventListener(e,function(i){var r=s.normalizedMousePosition(t.domElement,i);t.emit(e,r)},!1)}(t,r)}}function i(){e.call(this)}function r(){this.domElement&&(this.context.clearRect(0,0,this.domElement.width,this.domElement.height),this.context.putImageData(this.renderer.imageData,this.fit.x,this.fit.y),this.emit("update",this.frameCount))}return{constructor:p,init:function(e,i,r){r=r||{},"undefined"==typeof r.autostart&&(r.autostart=!0),this.text=e,this.renderer=i,this.pixelRatio=r.pixelRatio||s.pixelRatio;var n=this.renderer.material.mapper.sizeForText(e);this.fit={w:n.w,h:n.h,x:-1*~~(n.fit.x*this.pixelRatio),y:-1*~~((this.renderer.material.mapper.height-(n.fit.y+n.h))*this.pixelRatio)},this.playing=r.autostart,this.timeDelta=0,this.lastDrawTime,this.frameCount=0,this.domElement,this.context,t.call(this)},play:function(){this.playing=!0},pause:function(){this.playing=!1},update:function(){var t=Date.now();this.frameCount+=1,this.timeDelta=(t-(this.lastDrawTime||t))/1e3,this.lastDrawTime=t,r.call(this)},appendTo:function(t){this.domElement&&(this.domElement.remove(),this.context=null),this.domElement=s.hiDpiCanvas(this.fit.w,this.fit.h),this.context=this.domElement.getContext("2d"),t.appendChild(this.domElement),i.call(this)}}}();var m=function(t,e,i){this.init(t,e,i)};m.prototype=function(){return{constructor:m,init:function(t,e,i){this.scene=new THREE.Scene,this.renderTarget=new THREE.WebGLRenderTarget(t,e,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,type:THREE.UnsignedByteType}),this.renderTarget.texture.generateMipmaps=!1,this.renderTarget.width=t,this.renderTarget.height=e,this.material=i,this.plane=new THREE.PlaneGeometry(t,e),this.mesh=new THREE.Mesh(this.plane,this.material),this.scene.add(this.mesh),this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0,premultipliedAlpha:!1}),this.camera=new THREE.OrthographicCamera(t/-2,t/2,e/2,e/-2,0,100),this.viewBuffer=new ArrayBuffer(t*e*4),this.imageDataArray=new Uint8Array(this.viewBuffer),this.clampedImageDataArray=new Uint8ClampedArray(this.viewBuffer),this.imageData=new ImageData(this.clampedImageDataArray,t,e)},render:function(){this.renderer.render(this.scene,this.camera,this.renderTarget),this.renderer.readRenderTargetPixels(this.renderTarget,0,0,this.renderTarget.width,this.renderTarget.height,this.imageDataArray)},teardown:function(){this.renderer=null}}}(),t.Renderer=function(t){this.init(t)},t.Renderer.prototype=function(){function e(){var t=this;this.backBuffer.render(),this.imageData=this.backBuffer.imageData;for(var r in this.textScopes)this.textScopes[r].playing&&this.textScopes[r].update();this.currentAnimationLoop=i.requestAnimationFrame(function(){e.call(t)})}return{constructor:t.Renderer,init:function(t,e){e=e||{},"undefined"==typeof e.autostart&&(e.autostart=!0),Detector.webgl||a.throwError("Blotter.Renderer","device does not support webgl"),t.threeMaterial||a.throwError("Blotter.Renderer","material does not expose property threeMaterial. Did you forget to call #load on your Blotter.Material object before instantiating Blotter.Renderer?"),this.material=t,this.textScopes={},this.imageData,this.backBuffer=new m(this.material.width,this.material.height,this.material.threeMaterial),e.autostart&&this.start()},start:function(){this.currentAnimationLoop||e.call(this)},stop:function(){this.currentAnimationLoop&&(i.cancelAnimationFrame(this.currentAnimationLoop),this.currentAnimationLoop=void 0)},teardown:function(){this.stop(),this.backBuffer.teardown(),this.renderer=null},forText:function(e,i){if(!(e instanceof t.Text))return void a.logError("Blotter.Renderer","argument must be instanceof Blotter.Text");if(!this.material.hasText(e))return void a.logError("Blotter.Renderer","Blotter.Text object not found in material");if(i=i||{},"undefined"==typeof i.autostart&&(i.autostart=!0),i.pixelRatio=this.material.pixelRatio,!this.textScopes[e.id]){var r=new p(e,this,i);this.textScopes[e.id]=r}return this.textScopes[e.id]}}}(),this.Blotter=t}();