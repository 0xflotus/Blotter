<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <style type="text/css">
      body {
        background: #fff; //#202020;
        padding: 20px;
        font-family: Charcoal, sans-serif;
        font-size: 22px;
        line-height: 1.5;
        color: #0d0f17;
      }

      canvas {
        padding: 0;
        margin: 0;
        vertical-align: top;
      }

      /* TEMPORARY FOR TESTING (DAT.GUI) */
      .dg.ac {
        right: 200px!important;
      }
    </style>


    <script type="text/javascript" src="./third_party/dat.gui.js"></script>
    <script type="text/javascript" src="../build/blotter.js"></script>
    <script type="text/javascript" src="../build/materials/ghostBlurMaterial.js"></script>
  </head>
    <span id="target"></span>
    <script>



      //$(document).ready(function() {


        var blurSrc = [

          "float edgeDistanceBlur(vec2 fragCoord, float blurRadius) {",
          "    // Setup",
          "    // -------------------------------",

          "    const int maxSteps = 30; // This kind of sucks but we cant use non constant values for our loops",

          "    vec2 uv = fragCoord.xy / uResolution.xy;",
          "    vec2 p = vec2(1.0) / uResolution.xy; // 1 pixel.",
          "    float baseSample = textTexture(uv).a;",


          "    // Find Alpha from Bluring",
          "    // -------------------------------",

          "    float lightestSample = baseSample;",

          "    for (int i = -maxSteps; i <= maxSteps; i += 1) {",
          "        if (abs(float(i)) <= -blurRadius || abs(float(i)) >= blurRadius) { continue; }",
          "        for (int j = -maxSteps; j <= maxSteps; j += 1) {",
          "            if (abs(float(j)) <= -blurRadius || abs(float(j)) >= blurRadius) { continue; }",

          "            vec2 stepUv = uv + vec2(float(i) * p.x, float(j) * p.y);",
          "            vec2 stepCoord = stepUv * uResolution.xy;",

          "            float sampleOnBackground = textTexture(stepUv).a;",

          "            float stepDistance = distance(stepCoord, fragCoord);",

          "            if (stepDistance <= blurRadius) {",
          "               float stepLightestSampleWeight = 1.0 - pow((stepDistance / blurRadius), 2.0);",

          "               stepLightestSampleWeight = smoothstep(0.0, 1.0, stepLightestSampleWeight);",

          "               float mixedStep = mix(baseSample, sampleOnBackground, stepLightestSampleWeight);",

          "               lightestSample = min(mixedStep, lightestSample);",
          "            }",
          "        }",
          "    }",


          "   return lightestSample;",

          "}",


          "void mainImage( out vec4 mainImage, in vec2 fragCoord )",
          "{",
          "    float alphaBlur = edgeDistanceBlur(fragCoord, uBlurRadius);",

          "    mainImage = vec4(vec3(alphaBlur), 1.0);",
          "}"
        ].join("\n");

        var styleProperties = {
          family: "sans-serif",
          size : 124,
          weight : 100,
          paddingTop : 0,
          paddingLeft : 14,
          paddingRight : 14
        };

        var text = new Blotter.Text("observation", styleProperties);

        var material = new Blotter.ShaderMaterial(blurSrc, {
          uniforms : {
            uBlurRadius : { type : "1f", value : 5.0 }
          }
        });

        var blotter = new Blotter(material, {
          texts : text
        });

        var myScope = blotter.forText(text);

        blotter.on("ready", function () {
          myScope.appendTo(document.getElementById("target"));
        });

        var controls = {
          message : 'dat.gui',
          uBlurRadius : material.uniforms.uBlurRadius.value,
        };

        var gui = new dat.GUI();

        gui.add(controls, 'uBlurRadius', 0.0, 30.0).onChange(function (radius) {
          material.uniforms.uBlurRadius.value = radius;
        }).step(0.1);

      //});
    </script>
  </body>
</html>
