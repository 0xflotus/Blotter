<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r74/three.js"></script>
    <script type="text/javascript" src="blotter.min.js"></script>
  </head>
    <div style="display: none; font-size: 22px; line-height: 1.5; font-family: Charcoal, sans-serif; position: absolute; top: 24px; left: 47px; z-index: -10;">
      communicate pentagrams
    </div>
    <script>
      $(document).ready(function() {


        /**
        *   SET UP BLOTTER.
        *   ------------------------------------------------------
        */

        var mainImageSrc = [

          "vec3 mod289(vec3 x) {",
          "  return x - floor(x * (1.0 / 289.0)) * 289.0;",
          "}",

          "vec2 mod289(vec2 x) {",
          "  return x - floor(x * (1.0 / 289.0)) * 289.0;",
          "}",

          "vec3 permute(vec3 x) {",
          "  return mod289(((x*34.0)+1.0)*x);",
          "}",

          "float snoise(vec2 v) {",
          "  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0",
          "                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)",
          "                     -0.577350269189626,  // -1.0 + 2.0 * C.x",
          "                      0.024390243902439); // 1.0 / 41.0",
          "  vec2 i  = floor(v + dot(v, C.yy) );",
          "  vec2 x0 = v -   i + dot(i, C.xx);",

          "  vec2 i1;",
          "  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);",
          "  vec4 x12 = x0.xyxy + C.xxzz;",
          "  x12.xy -= i1;",

          "  i = mod289(i); // Avoid truncation effects in permutation",
          "  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 )) + i.x + vec3(0.0, i1.x, 1.0 ));",

          "  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);",
          "  m = m*m ;",
          "  m = m*m ;",

          "  vec3 x = 2.0 * fract(p * C.www) - 1.0;",
          "  vec3 h = abs(x) - 0.5;",
          "  vec3 ox = floor(x + 0.5);",
          "  vec3 a0 = x - ox;",

          "  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );",

          "  vec3 g;",
          "  g.x  = a0.x  * x0.x  + h.x  * x0.y;",
          "  g.yz = a0.yz * x12.xz + h.yz * x12.yw;",
          "  return 130.0 * dot(m, g);",
          "}",

          // End Ashima 2D Simplex Noise

          "void mainImage( out vec4 mainImage, in vec2 fragCoord ) {",

          "  vec2 p = fragCoord / uResolution;",
          "  float ty = uTime * uSpeed;",
          "  float yt = p.y - ty;",

             //smooth distortion
          "  float offset = snoise(vec2(yt * 3.0, 0.0)) * 0.2;",
             // boost distortion
          "  offset = offset * uDistortion * offset * uDistortion * offset;",
             //add fine grain distortion
          "  offset += snoise(vec2(yt * 50.0, 0.0)) * uDistortion2 * 0.001;",
             //combine distortion on X with roll on Y
          "  mainImage = textTexture(vec2(fract(p.x + offset), fract(p.y)));",

          "}"
        ].join("\n");


        var texts = ['To', 'communicate', 'Mars', 'converse', 'spirits', 'report', 'the', 'behaviour', 'of', 'sea', 'monster', 'Describe', 'horoscope', 'haruspicate', 'or', 'scry', 'Observe', 'disease', 'in', 'signatures', 'evoke', 'Biography', 'from', 'wrinkles', 'palm', 'And', 'tragedy', 'fingers', 'release', 'omens'];

        var styleProperties = {
          family: "Charcoal, sans-serif",
          size: 22,
          paddingTop: 12,
          paddingRight: 17,
          paddingBottom: 12,
          paddingLeft: 17,
          leading: 1.5,
          fill: "#0d0f17"
        };

        var blotterTexts = texts.map(function(text) { return new Blotter.Text(text, styleProperties); });

        var material = new Blotter.Material(blotterTexts, {
          mainImage : mainImageSrc,
          uniforms : {
            uTime : { type : "1f", value : 0.0 },
            uDistortion : { type : "1f", value : 0.0 },
            uDistortion2 : { type : "1f", value : 0.0 },
            uSpeed : { type : "1f", value : 0.1 }
          }
        });

        material.load(function () {
          var renderer = new Blotter.Renderer(material);

          for (var i = 0; i < blotterTexts.length; i++) {
            var text = blotterTexts[i];
                outputEl = document.createElement("span");
            outputEl.style.display = "inline-block";
            document.body.appendChild(outputEl);
            renderer.forText(text).appendTo(outputEl);
          }

          var startTime = new Date().getTime(),
              textRenderScope = renderer.forText(blotterTexts[12]),
              textMaterialScope = material.forText(blotterTexts[12]);

          textMaterialScope.uniforms.uDistortion.value = 3.0;
          textMaterialScope.uniforms.uDistortion2.value = 5.0;

          textRenderScope.on("update", function (frameCount) {
            var time = (new Date().getTime() - startTime) / 1000;
            textMaterialScope.uniforms.uTime.value = time;
          });
        });

      });
    </script>
  </body>
</html>
