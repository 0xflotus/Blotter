<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r74/three.js"></script>
    <script type="text/javascript" src="../blotter.js"></script>
  </head>
    <div style="font-size: 12px; line-height: 1.5; font-family: Charcoal, sans-serif; position: absolute; top: 24px; left: 47px; z-index: -10;">
      communicate pentagrams
    </div>
    <script>
      $(document).ready(function() {


        /**
        *   SET UP BLOTTER.
        *   ------------------------------------------------------
        */

        var mainImageSrc = [

          "void combineColors( out vec4 adjustedColor, in vec4 bg, in vec4 color ) {",
          "  float a = color.a;",

          "  float r = (1.0 - a) * bg.r + a * color.r;",
          "  float g = (1.0 - a) * bg.g + a * color.g;",
          "  float b = (1.0 - a) * bg.b + a * color.b;",

          "  adjustedColor = vec4(r, g, b, 1.0);",
          "}",

          "void rgbaFromRgb( out vec4 rgba, in vec3 rgb ) {",
          "  float a = 1.0 - min(rgb.r, min(rgb.g, rgb.b));",

          "  float r = 1.0 - (1.0 - rgb.r) / a;",
          "  float g = 1.0 - (1.0 - rgb.g) / a;",
          "  float b = 1.0 - (1.0 - rgb.b) / a;",

          "  rgba = vec4(r, g, b, a);",
          "}",

          "void mainImage( out vec4 mainImage, in vec2 fragCoord ) {",

          "   // p = x, y percentage for texel position within total resolution.",
          "   vec2 p = fragCoord / uResolution;",
          "   // d = x, y percentage for texel position within total resolution relative to center point.",
          "   vec2 d = p - uCenterPoint;",

          "   // The dot function returns the dot product of the two",
          "   // input parameters, i.e. the sum of the component-wise",
          "   // products. If x and y are the same the square root of",
          "   // the dot product is equivalent to the length of the vector.",
          "   // Therefore, r = length of vector represented by d (the ",
          "   // distance of the texel from center position).",
          "   // ",
          "   // In order to apply weights here, we add our weight to this distance",
          "   // (pushing it closer to 1 - essentially giving no effect at all) and",
          "   // find the min between our weighted distance and 1.0",
          "   float inverseLenseWeight = 1.0 - uLenseWeight;",
          "   float r = min(sqrt(dot(d, d)) + inverseLenseWeight, 1.0);",

          "   vec2 offsetUV = uCenterPoint + (d * r);",

          "   // RGB shift",
          "   vec2 offset = vec2(0.0);",
          "   if (r < 1.0) {",
          "     float amount = 0.012;",
          "     float angle = 0.45;",
          "     offset = (amount * (1.0 - r)) * vec2(cos(angle), sin(angle));",
          "   }",

          "   vec4 cr = textTexture(offsetUV + offset);",
          "   vec4 cga = textTexture(offsetUV);",
          "   vec4 cb = textTexture(offsetUV - offset);",

          "   combineColors(cr, vec4(1.0, 1.0, 1.0, 1.0), cr);",
          "   combineColors(cga, vec4(1.0, 1.0, 1.0, 1.0), cga);",
          "   combineColors(cb, vec4(1.0, 1.0, 1.0, 1.0), cb);",

          "   rgbaFromRgb(mainImage, vec3(cr.r, cga.g, cb.b));",
          "}"
        ].join("\n");


        var texts = ['To', 'communicate', 'Mars', 'converse', 'spirits', 'report', 'the', 'behaviour', 'of', 'sea', 'monster', 'Describe', 'horoscope', 'haruspicate', 'or', 'scry', 'Observe', 'disease', 'in', 'signatures', 'evoke', 'Biography', 'from', 'wrinkles', 'palm', 'And', 'tragedy', 'fingers', 'release', 'omens', 'By', 'sortilege', 'tea', 'leaves', 'riddle', 'inevitable', 'With', 'playing', 'cards', 'fiddle', 'pentagrams', 'Or', 'barbituric', 'acids', 'dissect', 'Sed', 'tincidunt', 'tempor', 'consectetur.', 'Cras', 'imperdiet', 'suscipit', 'massa,', 'ut', 'malesuada', 'enim', 'sollicitudin', 'in.', 'Nullam', 'cursus,', 'lorem', 'vitae', 'cursus', 'gravida,', 'erat'];

        var styleProperties = {
          family: "Charcoal, sans-serif",
          size: 12,
          paddingTop: 12,
          paddingRight: 17,
          paddingBottom: 12,
          paddingLeft: 17,
          leading: 1.5,
          fill: "#0d0f17"
        };

        var blotterTexts = texts.map(function(text) { return new Blotter.Text(text, styleProperties); });

        var material = new Blotter.Material(blotterTexts, {
          mainImage : mainImageSrc,
          uniforms : {
            uCenterPoint : { type : "2f", value : [0.5, 0.5] },
            uLenseWeight : { type : "1f", value : 0.9 }
          }
        });

        material.load(function () {
          var renderer = new Blotter.Renderer(material);

          for (var i = 0; i < blotterTexts.length; i++) {
            var text = blotterTexts[i];
                outputEl = document.createElement("span");
            outputEl.style.display = "inline-block";
            document.body.appendChild(outputEl);
            renderer.forText(text).appendTo(outputEl);
          }

          renderer.forText(blotterTexts[1]).on("mousemove", function (mousePosition) {
            material.forText(blotterTexts[1]).uniforms.uLenseWeight.value = 0.9;
            material.forText(blotterTexts[1]).uniforms.uCenterPoint.value = [mousePosition.x, mousePosition.y];
          });

          var startTime = new Date().getTime(),
              textRenderScope = renderer.forText(blotterTexts[23]),
              textMaterialScope = material.forText(blotterTexts[23]);

          textRenderScope.on("update", function (frameCount) {
            var time = (new Date().getTime() - startTime) / 1000;
            textMaterialScope.uniforms.uCenterPoint.value = [0.5, 0.5];
            textMaterialScope.uniforms.uLenseWeight.value = Math.abs(Math.sin(time));
          });
        });

      });
    </script>
  </body>
</html>
