<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <style type="text/css">
      body {
        background: #fff; //#202020;
        padding: 20px;
        font-family: Charcoal, sans-serif;
        font-size: 22px;
        line-height: 1.5;
        color: #0d0f17;
      }

      canvas {
        padding: 0;
        margin: 0;
        vertical-align: top;
      }

      /* TEMPORARY FOR TESTING (DAT.GUI) */
      .dg.ac {
        right: 200px!important;
      }
    </style>


    <script type="text/javascript" src="./third_party/dat.gui.js"></script>
    <script type="text/javascript" src="../build/blotter.js"></script>
  </head>
    <span id="target"></span>
    <script>



      //$(document).ready(function() {


        var blurSrc = [

          Blotter.Assets.Shaders.Noise2D,

          "float yLines(vec2 uv){",
          "    float lengthAdjuster = uLineLengthAdjuster;",
          "    float adjustedY = 1.0 - (lengthAdjuster * (uv.y));",
          "    float numLines = uNumLines * pow(adjustedY, uYPower);",

          "    float lines = sin((adjustedY) * (sin(smoothstep(-0.1, 1.1, uv.x) * 3.14)) * numLines);",

          "    return lines;",
          "}",

          "float yDistortion(vec2 uv) {",
          "    vec2 uvAdjustment = vec2(smoothstep(0.0, 1.0, pow(uv.y, 1.0)) * uYDistort, uXDistort);",
          "    float yDistortion = snoise(uv * uvAdjustment);",
          "    return 1.0 - yDistortion;",
          "}",

          "",
          "void mainImage( out vec4 mainImage, in vec2 fragCoord )",
          "{",
          "    vec2 uv = fragCoord.xy / uResolution.xy;",

          "    float distort = yDistortion(uv) * uDistort;",
          "    float lines = yLines(uv);",
          "    float screen = smoothstep(0.0, 1.0, (lines * distort));",

          "    vec4 baseSample = textTexture(uv + screen);",

          "    mainImage = vec4(screen);",
          "    mainImage = baseSample;//mix(baseSample, white, screen);",
          "}"
        ].join("\n");

        var styleProperties = {
          family: "serif",
          size : 424,
          weight : 100,
          leading: 1,
          paddingTop : 0,
          paddingLeft : 14,
          paddingRight : 14
        };

        var text = new Blotter.Text("20", styleProperties);

        var material = new Blotter.ShaderMaterial(blurSrc, {
          uniforms : {
            uXDistort : { type : "1f", value : 5.0 },
            uYDistort : { type : "1f", value : 5.0 },
            uDistort : { type : "1f", value : 0.2 },
            uNumLines : { type : "1f", value : 5.0 },
            uLineLengthAdjuster : { type : "1f", value : 1.75 },
            uYPower : { type : "1f", value : 2.5 }
          }
        });

        var blotter = new Blotter(material, {
          texts : text
        });

        var myScope = blotter.forText(text);

        blotter.on("ready", function () {
          myScope.appendTo(document.getElementById("target"));
        });

        var controls = {
          uXDistort : material.uniforms.uXDistort.value,
          uYDistort : material.uniforms.uYDistort.value,
          uDistort : material.uniforms.uDistort.value,
          uNumLines : material.uniforms.uNumLines.value,
          uLineLengthAdjuster : material.uniforms.uLineLengthAdjuster.value,
          uYPower : material.uniforms.uYPower.value,
        };

        var gui = new dat.GUI();

        gui.add(controls, 'uXDistort', 0.0, 30.0).onChange(function (radius) {
         material.uniforms.uXDistort.value = radius;
        }).step(0.1);
        gui.add(controls, 'uYDistort', 0.0, 30.0).onChange(function (radius) {
         material.uniforms.uYDistort.value = radius;
        }).step(0.1);
        gui.add(controls, 'uDistort', 0.001, 1.0).onChange(function (distort) {
         material.uniforms.uDistort.value = distort;
        }).step(0.001);
        gui.add(controls, 'uNumLines', 0.0, 70.0).onChange(function (radius) {
         material.uniforms.uNumLines.value = radius;
        }).step(1.0);
        gui.add(controls, 'uLineLengthAdjuster', 0.0, 2.0).onChange(function (length) {
         material.uniforms.uLineLengthAdjuster.value = length;
        }).step(0.1);
        gui.add(controls, 'uYPower', 0.0, 4.0).onChange(function (length) {
         material.uniforms.uYPower.value = length;
        }).step(0.01);

      //});
    </script>
  </body>
</html>
